import { initViewer, loadModel } from "./viewer.js";

initViewer(document.getElementById("preview")).then((viewer) => {
  const urn = window.location.hash?.substring(1);
  setupModelSelection(viewer, urn);
});

async function setupModelSelection(viewer, selectedUrn) {
  const dropdown = document.getElementById("models");
  dropdown.innerHTML = "";
  try {
    const resp = await fetch("/api/models");
    if (!resp.ok) {
      throw new Error(await resp.text());
    }
    const models = await resp.json();
    dropdown.innerHTML = models
      .map(
        (model) =>
          `<option value=${model.urn} ${
            model.urn === selectedUrn ? "selected" : ""
          }>${model.name}</option>`
      )
      .join("\n");
    dropdown.onchange = () => onModelSelected(viewer, dropdown.value);
    if (dropdown.value) {
      onModelSelected(viewer, dropdown.value);
    }
  } catch (err) {
    alert("Could not list models. See the console for more details.");
    console.error(err);
  }
}

async function onModelSelected(viewer, urn) {
  window.location.hash = urn;
  loadModel(viewer, urn);
}
